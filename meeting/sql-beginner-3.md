# SQL Beginner #3（集約）
{:.no_toc}

* toc
{:toc}

## 集約関数
```sql
-- 行数を数える
-- 列名を指定すると、NULLを除外して行数を数える。
SELECT COUNT(*), COUNT(cost) FROM items;
+----------+-------------+
| COUNT(*) | COUNT(cost) |
+----------+-------------+
|        9 |           7 |
+----------+-------------+

-- 合計値を算出する
-- 原則は1 + NULL = NULLであるが、集約関数では取り除いてから演算されるので矛盾していない。
SELECT SUM(price), SUM(cost) FROM items;
+------------+-----------+
| SUM(price) | SUM(cost) |
+------------+-----------+
|      24280 |     15960 |
+------------+-----------+

-- 平均値、最大値、最小値
SELECT AVG(price), MAX(price), MIN(price) FROM items;
+------------+------------+------------+
| AVG(price) | MAX(price) | MIN(price) |
+------------+------------+------------+
|  2697.7778 |       7500 |        100 |
+------------+------------+------------+

-- 最大値、最小値は数値以外のデータ型にも適用できる。
SELECT MAX(registered_at), MAX(name) FROM items;
+--------------------+--------------------+
| MAX(registered_at) | MAX(name)          |
+--------------------+--------------------+
| 2023-10-14         | 穴あけパンチ       |
+--------------------+--------------------+
```

## 重複の排除
```sql
-- 重複を排除することで商品分類の種類を計算する。
SELECT COUNT(DISTINCT genre) FROM items;
+-----------------------+
| COUNT(DISTINCT genre) |
+-----------------------+
|                     4 |
+-----------------------+

-- 重複した商品単価を排除して集約関数を適用できる。
SELECT SUM(price), SUM(DISTINCT price) FROM items;
+------------+---------------------+
| SUM(price) | SUM(DISTINCT price) |
+------------+---------------------+
|      24280 |               23780 |
+------------+---------------------+
```

## グループに分割
GROUP BY句によりディスクより取得した二次元表をグループに分割できる。  
SELECT -> FROM -> WHERE -> GROUP BY -> HAVING(後述)の順番で記述しなければならない。

GROUP BY句に指定する列を集約キーと呼ぶ。

GROUP BYを使用するSQL文のSELECT句には以下の3種類の値しか記述できない。
- 定数（'foo', 1...）
- 集約関数(COUNT, SUM, MAX...)
- 集約キー

```sql
SELECT genre, COUNT(*) FROM items GROUP BY genre;
+--------------------+----------+
| genre              | COUNT(*) |
+--------------------+----------+
| 衣服               |        2 |
| 事務用品           |        2 |
| キッチン用品       |        4 |
| 食品               |        1 |
+--------------------+----------+

-- NULLを含む列を集約キーに指定するとNULLを一つのグループと解釈する。
SELECT cost, COUNT(*) FROM items GROUP BY cost;
+------+----------+
| cost | COUNT(*) |
+------+----------+
|  500 |        1 |
|  320 |        1 |
| 2800 |        2 |
| 5000 |        1 |
| NULL |        2 |
|  790 |        1 |
| 3750 |        1 |
+------+----------+

-- WHERE句と併用すると絞り込まれた二次元表に対してグループ化が行われる。
SELECT price, COUNT(*) FROM items WHERE genre = '衣服' GROUP BY price;
+-------+----------+
| price | COUNT(*) |
+-------+----------+
|  1000 |        1 |
|  4000 |        1 |
+-------+----------+
```

## DISTINCTとGROUP BY
DISTINCTとGROUP BYを非常に似た動作をする。SQL文の意味に合わせて使い分ける。

```sql
-- 「商品分類一覧を見たい」という要件に対応するSQLは前者が望ましい。
SELECT DISTINCT genre FROM items;
SELECT genre FROM items GROUP BY genre;

-- 「商品分類ごとの平均商品単価を見たい」など集約が関わる場合はGROUP BYでしか表現できない。
SELECT genre, AVG(price) FROM items GROUP BY genre;
+--------------------+------------+
| genre              | AVG(price) |
+--------------------+------------+
| 衣服               |  2500.0000 |
| 事務用品           |   300.0000 |
| キッチン用品       |  2795.0000 |
| 食品               |  7500.0000 |
+--------------------+------------+
```

## グループに対して条件指定
WHERE句が行に対する条件指定ならば、HAVINGはグループに対する条件指定

```sql
SELECT genre, AVG(price)
FROM items
GROUP BY genre
HAVING AVG(price) > 2500;
+--------------------+------------+
| genre              | AVG(price) |
+--------------------+------------+
| キッチン用品       |  2795.0000 |
| 食品               |  7500.0000 |
+--------------------+------------+
```

## 並べ替え
ORDER BY句に指定する列をソートキーと呼ぶ。

```sql
SELECT name, price FROM items ORDER BY price;
+-----------------------+-------+
| name                  | price |
+-----------------------+-------+
| ボールペン            |   100 |
| 穴あけパンチ          |   500 |
| フォーク              |   500 |
| おろしがね            |   880 |
| Tシャツ               |  1000 |
| 包丁                  |  3000 |
| カッターシャツ        |  4000 |
| 圧力鍋                |  6800 |
| プロテイン            |  7500 |
+-----------------------+-------+

-- NULLを含む列は先頭または末尾に並べ替えられる。
SELECT name, cost FROM items ORDER BY cost;
+-----------------------+------+
| name                  | cost |
+-----------------------+------+
| フォーク              | NULL |
| ボールペン            | NULL |
| 穴あけパンチ          |  320 |
| Tシャツ               |  500 |
| おろしがね            |  790 |
| カッターシャツ        | 2800 |
| 包丁                  | 2800 |
| プロテイン            | 3750 |
| 圧力鍋                | 5000 |
+-----------------------+------+

-- 集約結果も並べ替えられる。
SELECT genre, MAX(price) FROM items GROUP BY genre ORDER BY MAX(price);
+--------------------+------------+
| genre              | MAX(price) |
+--------------------+------------+
| 事務用品           |        500 |
| 衣服               |       4000 |
| キッチン用品       |       6800 |
| 食品               |       7500 |
+--------------------+------------+

-- 複数のソートキーを指定できる。
SELECT name, price, cost FROM items ORDER BY price, cost;
+-----------------------+-------+------+
| name                  | price | cost |
+-----------------------+-------+------+
| ボールペン            |   100 | NULL |
| フォーク              |   500 | NULL |
| 穴あけパンチ          |   500 |  320 |
| おろしがね            |   880 |  790 |
| Tシャツ               |  1000 |  500 |
| 包丁                  |  3000 | 2800 |
| カッターシャツ        |  4000 | 2800 |
| 圧力鍋                |  6800 | 5000 |
| プロテイン            |  7500 | 3750 |
+-----------------------+-------+------+

-- ソートキーに昇順・降順を指定できる。指定しない場合は昇順となる。
SELECT name, price FROM items ORDER BY price ASC;
SELECT name, price FROM items ORDER BY price;
+-----------------------+-------+
| name                  | price |
+-----------------------+-------+
| ボールペン            |   100 |
| 穴あけパンチ          |   500 |
| フォーク              |   500 |
| おろしがね            |   880 |
| Tシャツ               |  1000 |
| 包丁                  |  3000 |
| カッターシャツ        |  4000 |
| 圧力鍋                |  6800 |
| プロテイン            |  7500 |
+-----------------------+-------+

SELECT name, price FROM items ORDER BY price DESC;
+-----------------------+-------+
| name                  | price |
+-----------------------+-------+
| プロテイン            |  7500 |
| 圧力鍋                |  6800 |
| カッターシャツ        |  4000 |
| 包丁                  |  3000 |
| Tシャツ               |  1000 |
| おろしがね            |   880 |
| 穴あけパンチ          |   500 |
| フォーク              |   500 |
| ボールペン            |   100 |
+-----------------------+-------+
```
