# SQL Beginner #8 （ウィンドウ関数・GROUPING演算子）

## ウィンドウ関数
ウィンドウ関数は集約関数と同じようにレコードをグループに切り分けて処理する。  
しかし集約関数と異なり、レコードを維持したまま計算を実施できる。

ウィンドウ関数では切り分けられたグループのことをウィンドウ（区間）と呼ぶ。

### RANK関数
```sql
-- 分類ごとに金額の低い順に出力する。
SELECT
  id,
  name,
  genre,
  price,
  RANK() OVER (
    PARTITION BY genre
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  6 | フォーク              | キッチン用品       |   500 |          1 |
|  7 | おろしがね            | キッチン用品       |   880 |          2 |
|  4 | 包丁                  | キッチン用品       |  3000 |          3 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          4 |
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  1 | Tシャツ               | 衣服               |  1000 |          1 |
|  3 | カッターシャツ        | 衣服               |  4000 |          2 |
|  9 | プロテイン            | 食品               |  7500 |          1 |
+----+-----------------------+--------------------+-------+------------+

-- PARTITION BYは省略すると全体を一つのウィンドウとして取り扱う。
SELECT
  id,
  name,
  genre,
  price,
  RANK() OVER (
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  6 | フォーク              | キッチン用品       |   500 |          2 |
|  7 | おろしがね            | キッチン用品       |   880 |          4 |
|  1 | Tシャツ               | 衣服               |  1000 |          5 |
|  4 | 包丁                  | キッチン用品       |  3000 |          6 |
|  3 | カッターシャツ        | 衣服               |  4000 |          7 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          8 |
|  9 | プロテイン            | 食品               |  7500 |          9 |
+----+-----------------------+--------------------+-------+------------+

-- DENSE_RANK関数は同順となるレコードが存在するときに後続の順位が飛ばなくなる。
SELECT
  id,
  name,
  genre,
  price,
  DENSE_RANK() OVER (
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
-- RANK関数と異なりおろしがねが4位ではなく3位となった。
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  6 | フォーク              | キッチン用品       |   500 |          2 |
|  7 | おろしがね            | キッチン用品       |   880 |          3 |
|  1 | Tシャツ               | 衣服               |  1000 |          4 |
|  4 | 包丁                  | キッチン用品       |  3000 |          5 |
|  3 | カッターシャツ        | 衣服               |  4000 |          6 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          7 |
|  9 | プロテイン            | 食品               |  7500 |          8 |
+----+-----------------------+--------------------+-------+------------+
```

### ROW_NUMBER関数
```sql
-- 一見するとRANK関数と同じ挙動に見えることもあるが、値が重複したレコードにも順番を付ける。
-- 順序はRDBMSの実装やレコードの状況によって変わるため保証されていないと考える。
SELECT
  id,
  name,
  genre,
  price,
  ROW_NUMBER() OVER (
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
-- 穴あけパンチとフォークが同額であるが異なる順位となった。
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  6 | フォーク              | キッチン用品       |   500 |          3 |
|  7 | おろしがね            | キッチン用品       |   880 |          4 |
|  1 | Tシャツ               | 衣服               |  1000 |          5 |
|  4 | 包丁                  | キッチン用品       |  3000 |          6 |
|  3 | カッターシャツ        | 衣服               |  4000 |          7 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          8 |
|  9 | プロテイン            | 食品               |  7500 |          9 |
+----+-----------------------+--------------------+-------+------------+
```

### ウィンドウ関数としての集約関数
```sql
-- 累積
SELECT
  id, name, genre, price,
  SUM(price) OVER (
    ORDER BY price ASC
  ) AS sum
FROM
  items;
+----+-----------------------+--------------------+-------+-------+
| id | name                  | genre              | price | sum   |
+----+-----------------------+--------------------+-------+-------+
|  8 | ボールペン            | 事務用品           |   100 |   100 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |  1100 |
|  6 | フォーク              | キッチン用品       |   500 |  1100 |
|  7 | おろしがね            | キッチン用品       |   880 |  1980 |
|  1 | Tシャツ               | 衣服               |  1000 |  2980 |
|  4 | 包丁                  | キッチン用品       |  3000 |  5980 |
|  3 | カッターシャツ        | 衣服               |  4000 |  9980 |
|  5 | 圧力鍋                | キッチン用品       |  6800 | 16780 |
|  9 | プロテイン            | 食品               |  7500 | 24280 |
+----+-----------------------+--------------------+-------+-------+

-- ウィンドウを指定することで分類ごとに累計を算出できる。
SELECT
  id, name, genre, price,
  SUM(price) OVER (
    PARTITION BY genre
    ORDER BY price ASC
  ) AS sum
FROM
  items;
+----+-----------------------+--------------------+-------+-------+
| id | name                  | genre              | price | sum   |
+----+-----------------------+--------------------+-------+-------+
|  6 | フォーク              | キッチン用品       |   500 |   500 |
|  7 | おろしがね            | キッチン用品       |   880 |  1380 |
|  4 | 包丁                  | キッチン用品       |  3000 |  4380 |
|  5 | 圧力鍋                | キッチン用品       |  6800 | 11180 |
|  8 | ボールペン            | 事務用品           |   100 |   100 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |   600 |
|  1 | Tシャツ               | 衣服               |  1000 |  1000 |
|  3 | カッターシャツ        | 衣服               |  4000 |  5000 |
|  9 | プロテイン            | 食品               |  7500 |  7500 |
+----+-----------------------+--------------------+-------+-------+

-- ウィンドウの中でフレーム（＝集計範囲）を指定
-- 移動平均
SELECT
  id, name, genre, price,
  AVG(price) OVER (
    ORDER BY price ASC
    ROWS 2 PRECEDING
  ) AS avg
FROM
  items;
+----+-----------------------+--------------------+-------+-----------+
| id | name                  | genre              | price | avg       |
+----+-----------------------+--------------------+-------+-----------+
|  8 | ボールペン            | 事務用品           |   100 |  100.0000 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |  300.0000 |
|  6 | フォーク              | キッチン用品       |   500 |  366.6667 |
|  7 | おろしがね            | キッチン用品       |   880 |  626.6667 |
|  1 | Tシャツ               | 衣服               |  1000 |  793.3333 |
|  4 | 包丁                  | キッチン用品       |  3000 | 1626.6667 |
|  3 | カッターシャツ        | 衣服               |  4000 | 2666.6667 |
|  5 | 圧力鍋                | キッチン用品       |  6800 | 4600.0000 |
|  9 | プロテイン            | 食品               |  7500 | 6100.0000 |
+----+-----------------------+--------------------+-------+-----------+

-- フレームの指定方法
-- 2行前から現在の行まで
ROWS 2 PRECEDING
-- 現在の行から2行先まで
ROWS BETWEEN CURRENT ROW AND 2 FOLLOWING
-- 2行前から2行後まで
ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING
-- 先頭から現在の行まで（デフォルト）
ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
-- 現在の行から末尾まで
ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING
```

## GROUPING演算子
GROUP BY句で求めた小計をさらに合計するようなグループに対するメタ的な操作を提供する。

```sql
-- 分類ごとの小計
SELECT genre, SUM(price) FROM items GROUP BY genre;
+--------------------+------------+
| genre              | SUM(price) |
+--------------------+------------+
| 衣服               |       5000 |
| 事務用品           |        600 |
| キッチン用品       |      11180 |
| 食品               |       7500 |
+--------------------+------------+

-- すべての商品の合計
SELECT '合計', SUM(price) FROM items;
+--------+------------+
| 合計   | SUM(price) |
+--------+------------+
| 合計   |      24280 |
+--------+------------+

-- レコードの和を取ることで表現できるが同様のクエリを2回投げてしまっている。
SELECT '合計', SUM(price) FROM items
UNION ALL
SELECT genre, SUM(price) FROM items GROUP BY genre;
+--------------------+------------+
| 合計               | SUM(price) |
+--------------------+------------+
| 合計               |      24280 |
| 衣服               |       5000 |
| 事務用品           |        600 |
| キッチン用品       |      11180 |
| 食品               |       7500 |
+--------------------+------------+

-- ROLLUP
-- WITH ROLLUPを付与するだけで合計行を追加できる。
-- NULLは集約キーを指定しない場合のグループ小計であると解釈できる。
SELECT genre, SUM(price)
FROM items
GROUP BY genre WITH ROLLUP;
+--------------------+------------+
| genre              | SUM(price) |
+--------------------+------------+
| キッチン用品       |      11180 |
| 事務用品           |        600 |
| 衣服               |       5000 |
| 食品               |       7500 |
| NULL               |      24280 |
+--------------------+------------+

-- 複合集約キーを取ると挙動が分かりやすい。
SELECT genre, registered_at, SUM(price)
FROM items
GROUP BY genre, registered_at WITH ROLLUP;

-- 「キッチン用品、NULL」の行はキッチン用品の分類に関する小計
-- 「NULL、NULL」の行は集約キーを指定しない場合の小計
+--------------------+---------------+------------+
| genre              | registered_at | SUM(price) |
+--------------------+---------------+------------+
| キッチン用品       | 2008-04-28    |        880 |
| キッチン用品       | 2009-01-15    |       6800 |
| キッチン用品       | 2009-09-20    |       3500 |
| キッチン用品       | NULL          |      11180 |
| 事務用品           | 2009-09-11    |        500 |
| 事務用品           | 2009-11-11    |        100 |
| 事務用品           | NULL          |        600 |
| 衣服               | NULL          |       4000 |
| 衣服               | 2009-09-20    |       1000 |
| 衣服               | NULL          |       5000 |
| 食品               | 2023-10-14    |       7500 |
| 食品               | NULL          |       7500 |
| NULL               | NULL          |      24280 |
+--------------------+---------------+------------+

-- 以下のレコードでは「衣服、"NULL"」のグループと「衣服、NULL」のグループの区別がつかない。
| 衣服               | NULL          |       4000 |
| 衣服               | 2009-09-20    |       1000 |
| 衣服               | NULL          |       5000 |

-- GROUPING関数によって超集合行の判別ができる。
-- 超集合行の場合は1、NULLという値の場合は0となる。
SELECT genre, GROUPING(genre), registered_at, GROUPING(registered_at), SUM(price)
FROM items
GROUP BY genre, registered_at WITH ROLLUP;
| 衣服               |               0 | NULL          |                       0 |       4000 |
| 衣服               |               0 | 2009-09-20    |                       0 |       1000 |
| 衣服               |               0 | NULL          |                       1 |       5000 |
```