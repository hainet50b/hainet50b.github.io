# SQL Beginner #8 （ウィンドウ関数）

## ウィンドウ関数
ウィンドウ関数は集約関数と同じようにレコードをグループに切り分けて処理する。  
しかし集約関数と異なり、レコードを維持したまま計算を実施できる。

ウィンドウ関数では切り分けられたグループのことをウィンドウ（区間）と呼ぶ。

### RANK関数
```sql
-- 分類ごとに金額の低い順に出力する。
SELECT
  id,
  name,
  genre,
  price,
  RANK() OVER (
    PARTITION BY genre
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  6 | フォーク              | キッチン用品       |   500 |          1 |
|  7 | おろしがね            | キッチン用品       |   880 |          2 |
|  4 | 包丁                  | キッチン用品       |  3000 |          3 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          4 |
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  1 | Tシャツ               | 衣服               |  1000 |          1 |
|  3 | カッターシャツ        | 衣服               |  4000 |          2 |
|  9 | プロテイン            | 食品               |  7500 |          1 |
+----+-----------------------+--------------------+-------+------------+

-- PARTITION BYは省略すると全体を一つのウィンドウとして取り扱う。
SELECT
  id,
  name,
  genre,
  price,
  RANK() OVER (
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  6 | フォーク              | キッチン用品       |   500 |          2 |
|  7 | おろしがね            | キッチン用品       |   880 |          4 |
|  1 | Tシャツ               | 衣服               |  1000 |          5 |
|  4 | 包丁                  | キッチン用品       |  3000 |          6 |
|  3 | カッターシャツ        | 衣服               |  4000 |          7 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          8 |
|  9 | プロテイン            | 食品               |  7500 |          9 |
+----+-----------------------+--------------------+-------+------------+

-- DENSE_RANK関数は同順となるレコードが存在するときに後続の順位が飛ばなくなる。
SELECT
  id,
  name,
  genre,
  price,
  DENSE_RANK() OVER (
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
-- RANK関数と異なりおろしがねが4位ではなく3位となった。
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  6 | フォーク              | キッチン用品       |   500 |          2 |
|  7 | おろしがね            | キッチン用品       |   880 |          3 |
|  1 | Tシャツ               | 衣服               |  1000 |          4 |
|  4 | 包丁                  | キッチン用品       |  3000 |          5 |
|  3 | カッターシャツ        | 衣服               |  4000 |          6 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          7 |
|  9 | プロテイン            | 食品               |  7500 |          8 |
+----+-----------------------+--------------------+-------+------------+
```

### ROW_NUMBER関数
```sql
-- 一見するとRANK関数と同じ挙動に見えることもあるが、値が重複したレコードにも順番を付ける。
-- 順序はRDBMSの実装やレコードの状況によって変わるため保証されていないと考える。
SELECT
  id,
  name,
  genre,
  price,
  ROW_NUMBER() OVER (
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
-- 穴あけパンチとフォークが同額であるが異なる順位となった。
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  6 | フォーク              | キッチン用品       |   500 |          3 |
|  7 | おろしがね            | キッチン用品       |   880 |          4 |
|  1 | Tシャツ               | 衣服               |  1000 |          5 |
|  4 | 包丁                  | キッチン用品       |  3000 |          6 |
|  3 | カッターシャツ        | 衣服               |  4000 |          7 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          8 |
|  9 | プロテイン            | 食品               |  7500 |          9 |
+----+-----------------------+--------------------+-------+------------+
```

### ウィンドウ関数としての集約関数
```sql
-- 累積
SELECT
  id, name, genre, price,
  SUM(price) OVER (
    ORDER BY price ASC
  ) AS sum
FROM
  items;
+----+-----------------------+--------------------+-------+-------+
| id | name                  | genre              | price | sum   |
+----+-----------------------+--------------------+-------+-------+
|  8 | ボールペン            | 事務用品           |   100 |   100 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |  1100 |
|  6 | フォーク              | キッチン用品       |   500 |  1100 |
|  7 | おろしがね            | キッチン用品       |   880 |  1980 |
|  1 | Tシャツ               | 衣服               |  1000 |  2980 |
|  4 | 包丁                  | キッチン用品       |  3000 |  5980 |
|  3 | カッターシャツ        | 衣服               |  4000 |  9980 |
|  5 | 圧力鍋                | キッチン用品       |  6800 | 16780 |
|  9 | プロテイン            | 食品               |  7500 | 24280 |
+----+-----------------------+--------------------+-------+-------+

-- ウィンドウを指定することで分類ごとに累計を算出できる。
SELECT
  id, name, genre, price,
  SUM(price) OVER (
    PARTITION BY genre
    ORDER BY price ASC
  ) AS sum
FROM
  items;
+----+-----------------------+--------------------+-------+-------+
| id | name                  | genre              | price | sum   |
+----+-----------------------+--------------------+-------+-------+
|  6 | フォーク              | キッチン用品       |   500 |   500 |
|  7 | おろしがね            | キッチン用品       |   880 |  1380 |
|  4 | 包丁                  | キッチン用品       |  3000 |  4380 |
|  5 | 圧力鍋                | キッチン用品       |  6800 | 11180 |
|  8 | ボールペン            | 事務用品           |   100 |   100 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |   600 |
|  1 | Tシャツ               | 衣服               |  1000 |  1000 |
|  3 | カッターシャツ        | 衣服               |  4000 |  5000 |
|  9 | プロテイン            | 食品               |  7500 |  7500 |
+----+-----------------------+--------------------+-------+-------+

-- ウィンドウの中でフレーム（＝集計範囲）を指定
-- 移動平均
SELECT
  id, name, genre, price,
  AVG(price) OVER (
    ORDER BY price ASC
    ROWS 2 PRECEDING
  ) AS avg
FROM
  items;
+----+-----------------------+--------------------+-------+-----------+
| id | name                  | genre              | price | avg       |
+----+-----------------------+--------------------+-------+-----------+
|  8 | ボールペン            | 事務用品           |   100 |  100.0000 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |  300.0000 |
|  6 | フォーク              | キッチン用品       |   500 |  366.6667 |
|  7 | おろしがね            | キッチン用品       |   880 |  626.6667 |
|  1 | Tシャツ               | 衣服               |  1000 |  793.3333 |
|  4 | 包丁                  | キッチン用品       |  3000 | 1626.6667 |
|  3 | カッターシャツ        | 衣服               |  4000 | 2666.6667 |
|  5 | 圧力鍋                | キッチン用品       |  6800 | 4600.0000 |
|  9 | プロテイン            | 食品               |  7500 | 6100.0000 |
+----+-----------------------+--------------------+-------+-----------+

-- フレームの指定方法
-- 2行前から現在の行まで
ROWS 2 PRECEDING
-- 現在の行から2行先まで
ROWS BETWEEN CURRENT ROW AND 2 FOLLOWING
-- 2行前から2行後まで
ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING
-- 先頭から現在の行まで（デフォルト）
ROWS BETWEEN UNBOUDED ROWS AND CURRENT ROW
-- 現在の行から末尾まで
ROWS BETWEEN CURRENT ROW AND UNBOUNDED ROWS
```