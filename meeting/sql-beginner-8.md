# SQL Beginner #8 （ウィンドウ関数）

## ウィンドウ関数
ウィンドウ関数は集約関数と同じようにレコードをグループに切り分けて処理する。  
しかし集約関数と異なり、レコードを維持したまま計算を実施できる。

ウィンドウ関数では切り分けられたグループのことをウィンドウ（区間）と呼ぶ。

### RANK関数
```sql
-- 分類ごとに金額の低い順に出力する。
SELECT
  id,
  name,
  genre,
  price,
  RANK() OVER (
    PARTITION BY genre
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  6 | フォーク              | キッチン用品       |   500 |          1 |
|  7 | おろしがね            | キッチン用品       |   880 |          2 |
|  4 | 包丁                  | キッチン用品       |  3000 |          3 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          4 |
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  1 | Tシャツ               | 衣服               |  1000 |          1 |
|  3 | カッターシャツ        | 衣服               |  4000 |          2 |
|  9 | プロテイン            | 食品               |  7500 |          1 |
+----+-----------------------+--------------------+-------+------------+

-- PARTITION BYは省略すると全体を一つのウィンドウとして取り扱う。
SELECT
  id,
  name,
  genre,
  price,
  RANK() OVER (
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  6 | フォーク              | キッチン用品       |   500 |          2 |
|  7 | おろしがね            | キッチン用品       |   880 |          4 |
|  1 | Tシャツ               | 衣服               |  1000 |          5 |
|  4 | 包丁                  | キッチン用品       |  3000 |          6 |
|  3 | カッターシャツ        | 衣服               |  4000 |          7 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          8 |
|  9 | プロテイン            | 食品               |  7500 |          9 |
+----+-----------------------+--------------------+-------+------------+

-- DENSE_RANK関数は同順となるレコードが存在するときに後続の順位が飛ばなくなる。
SELECT
  id,
  name,
  genre,
  price,
  DENSE_RANK() OVER (
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
-- RANK関数と異なりおろしがねが4位ではなく3位となった。
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  6 | フォーク              | キッチン用品       |   500 |          2 |
|  7 | おろしがね            | キッチン用品       |   880 |          3 |
|  1 | Tシャツ               | 衣服               |  1000 |          4 |
|  4 | 包丁                  | キッチン用品       |  3000 |          5 |
|  3 | カッターシャツ        | 衣服               |  4000 |          6 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          7 |
|  9 | プロテイン            | 食品               |  7500 |          8 |
+----+-----------------------+--------------------+-------+------------+
```

### ROW_NUMBER関数
```sql
-- 一見するとRANK関数と同じ挙動に見えることもあるが、値が重複したレコードにも順番を付ける。
-- 順序はRDBMSの実装やレコードの状況によって変わるため保証されていないと考える。
SELECT
  id,
  name,
  genre,
  price,
  ROW_NUMBER() OVER (
    ORDER BY price ASC
  ) AS price_rank
FROM
  items;
-- 穴あけパンチとフォークが同額であるが異なる順位となった。
+----+-----------------------+--------------------+-------+------------+
| id | name                  | genre              | price | price_rank |
+----+-----------------------+--------------------+-------+------------+
|  8 | ボールペン            | 事務用品           |   100 |          1 |
|  2 | 穴あけパンチ          | 事務用品           |   500 |          2 |
|  6 | フォーク              | キッチン用品       |   500 |          3 |
|  7 | おろしがね            | キッチン用品       |   880 |          4 |
|  1 | Tシャツ               | 衣服               |  1000 |          5 |
|  4 | 包丁                  | キッチン用品       |  3000 |          6 |
|  3 | カッターシャツ        | 衣服               |  4000 |          7 |
|  5 | 圧力鍋                | キッチン用品       |  6800 |          8 |
|  9 | プロテイン            | 食品               |  7500 |          9 |
+----+-----------------------+--------------------+-------+------------+
```